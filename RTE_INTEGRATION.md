# ORCA DAM - Rich Text Editor Integration Examples


## Authentication

ORCA supports two authentication methods for API access:

1. **Sanctum Tokens** - Long-lived tokens for backend-to-backend integrations
2. **JWT (JSON Web Tokens)** - Short-lived tokens ideal for frontend RTE integrations

Choose the method that best fits your integration scenario.

---

## Option A: Sanctum Tokens (Backend Integrations)

Sanctum tokens are best when your backend makes API calls directly to ORCA.
**Never expose Sanctum tokens to frontend code** - use a backend proxy instead.

Tokens are generated by the ORCA Administrator using one of the methods below.

### Option 1: Web Interface (Recommended)

1. Log in to ORCA as an admin
2. Go to **API Docs** (in user dropdown menu)
3. Click the **API Tokens** tab
4. Fill in the form:
   - **Token Name**: A descriptive name (e.g., "TinyMCE Java Integration")
   - **User**: Select an existing user OR create a new API user
5. Click **Create Token**
6. **Copy the token immediately** — it will only be shown once!

> **Tip**: Create a dedicated API user (role: `api`) for external integrations. API users have limited permissions: they can view, create, and update assets, but cannot delete assets or access admin features.

### Option 2: Using Artisan Commands

```bash
# Create token for an existing user
php artisan token:create user@example.com --name="TinyMCE Integration"

# Create a new API user and token (interactive)
php artisan token:create --new

# List all tokens
php artisan token:list

# Revoke a token
php artisan token:revoke 5
```

### Option 3: Using Tinker

For one-off token creation:

```bash
php artisan tinker
```

```php
$user = \App\Models\User::where('email', 'developer@example.com')->first();
$token = $user->createToken('tinymce-integration');
$token->plainTextToken  // Copy this!
```

---

## What to Give the Developer

Provide them with:

1. **The API Token or JWT Secret** (from one of the methods above)
2. **Base URL**: `https://your-orca-domain.com/api`
3. **How to authenticate**: Include the token in the Authorization header:
   ```
   Authorization: Bearer <token>
   ```

---

## Example API Request

```bash
curl -H "Authorization: Bearer 1|abc123xyz..." \
     -H "Accept: application/json" \
     https://your-orca-domain.com/api/assets
```

---

## Token Management

### Via Web UI (API Docs → API Tokens)
- View all tokens with user info and last used timestamp
- Create new tokens for existing or new users
- Revoke tokens with one click

### Via Artisan Commands
```bash
php artisan token:list                  # List all tokens
php artisan token:list --user=email     # Filter by user
php artisan token:revoke 5              # Revoke by ID
php artisan token:revoke --user=email   # Revoke all for user
```

### Additional Notes
- Tokens don't expire by default (configure in `config/sanctum.php` if needed)
- API users (role: `api`) cannot delete assets or access admin features
- The developer can use endpoints like `GET /api/assets`, `GET /api/assets/{id}`, etc.

---

## Option B: JWT Authentication (Frontend Integrations)

JWT authentication is ideal for frontend RTE integrations where you need short-lived tokens that can safely be passed to browser code. Your backend generates JWTs using a shared secret; ORCA validates them.

### How JWT Authentication Works

1. **Admin generates a JWT secret** for a user (via UI or CLI)
2. **Share the secret** with your backend system (keep it secure!)
3. **Your backend generates short-lived JWTs** using the secret
4. **Your frontend receives the JWT** and uses it for ORCA API requests
5. **ORCA validates** the JWT signature and expiry

### Enable JWT Authentication

First, enable JWT auth in ORCA's `.env` file:
```env
JWT_ENABLED=true
JWT_MAX_TTL=36000      # Maximum token lifetime (10 hours)
```

### Generate a JWT Secret

#### Via Web Interface
1. Log in to ORCA as an admin
2. Go to **API Docs** (in user dropdown menu)
3. Click the **JWT Secrets** tab
4. Select a user and click **Generate Secret**
5. **Copy the secret immediately** — it will only be shown once!

#### Via Artisan Commands
```bash
# Generate JWT secret for a user
php artisan jwt:generate user@example.com

# List users with JWT secrets
php artisan jwt:list

# Revoke a JWT secret
php artisan jwt:revoke user@example.com
```

### Generate JWTs in Your Backend

Your backend generates short-lived JWTs using the shared secret.

#### Node.js Example
```javascript
const jwt = require('jsonwebtoken');

// Generate a JWT for the frontend
function generateOrcaToken(userId, jwtSecret) {
    return jwt.sign(
        { sub: userId },           // ORCA user ID (required)
        jwtSecret,                 // Secret from ORCA
        {
            expiresIn: '1h',       // Token lifetime
            algorithm: 'HS256'     // Required algorithm
        }
    );
}

// API endpoint to get a token for the current user
app.get('/api/orca-token', authenticate, (req, res) => {
    const token = generateOrcaToken(ORCA_USER_ID, process.env.ORCA_JWT_SECRET);
    res.json({ token });
});
```

#### PHP Example
```php
use Firebase\JWT\JWT;

function generateOrcaToken(int $userId, string $jwtSecret): string
{
    $payload = [
        'sub' => $userId,           // ORCA user ID (required)
        'iat' => time(),            // Issued at (required)
        'exp' => time() + 3600,     // Expires in 1 hour (required)
    ];

    return JWT::encode($payload, $jwtSecret, 'HS256');
}

// In your controller
public function getOrcaToken(Request $request)
{
    $token = generateOrcaToken(
        config('services.orca.user_id'),
        config('services.orca.jwt_secret')
    );

    return response()->json(['token' => $token]);
}
```

#### Python Example
```python
import jwt
from datetime import datetime, timedelta

def generate_orca_token(user_id: int, jwt_secret: str) -> str:
    payload = {
        'sub': user_id,
        'iat': datetime.utcnow(),
        'exp': datetime.utcnow() + timedelta(hours=1)
    }
    return jwt.encode(payload, jwt_secret, algorithm='HS256')

# Flask example
@app.route('/api/orca-token')
@login_required
def get_orca_token():
    token = generate_orca_token(ORCA_USER_ID, ORCA_JWT_SECRET)
    return jsonify({'token': token})
```

#### Java Spring Boot Example
```java
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.Date;
import java.util.Map;

@RestController
public class OrcaTokenController {

    @Value("${orca.jwt.secret}")
    private String jwtSecret;

    @Value("${orca.user.id}")
    private Long orcaUserId;

    @GetMapping("/api/orca-token")
    public Map<String, String> getOrcaToken() {
        String token = generateOrcaToken(orcaUserId, jwtSecret);
        return Map.of("token", token);
    }

    private String generateOrcaToken(Long userId, String secret) {
        Instant now = Instant.now();
        SecretKey key = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));

        return Jwts.builder()
                .claim("sub", userId)              // ORCA user ID (required)
                .issuedAt(Date.from(now))          // iat claim (required)
                .expiration(Date.from(now.plus(1, ChronoUnit.HOURS)))  // exp claim (required)
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }
}
```

Add the dependency to your `pom.xml`:
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.12.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.12.5</version>
    <scope>runtime</scope>
</dependency>
```

Or for Gradle (`build.gradle`):
```groovy
implementation 'io.jsonwebtoken:jjwt-api:0.12.5'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.5'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.5'
```

Configure in `application.properties`:
```properties
orca.jwt.secret=your-64-character-secret-from-orca
orca.user.id=1
```

### Use JWT in Frontend

Your frontend requests a JWT from your backend, then uses it for ORCA API calls:

```javascript
// Get JWT from your backend
async function getOrcaToken() {
    const response = await fetch('/api/orca-token', {
        credentials: 'include'  // Include session cookie
    });
    const data = await response.json();
    return data.token;
}

// Use JWT for ORCA API calls
async function fetchOrcaAssets(search = '', sort = 'date_desc') {
    const token = await getOrcaToken();

    const response = await fetch(
        `https://your-orca-dam.com/api/assets?search=${search}&sort=${sort}`,
        {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        }
    );

    return response.json();
}
```

### JWT Required Claims

| Claim | Description | Required |
|-------|-------------|----------|
| `sub` | ORCA user ID (integer) | Yes |
| `exp` | Expiration timestamp (Unix) | Yes |
| `iat` | Issued-at timestamp (Unix) | Yes |
| `iss` | Issuer identifier | Only if `JWT_ISSUER` is configured |

### JWT vs Sanctum: When to Use Which

| Scenario | Recommended Auth |
|----------|------------------|
| Backend-to-backend API calls | Sanctum Token |
| Server-side rendering | Sanctum Token |
| Frontend RTE picker (browser) | JWT |
| Mobile app | JWT |
| Single-page application | JWT |
| Cron jobs / scheduled tasks | Sanctum Token |

---

## TinyMCE Integration

### Basic Setup

```javascript
tinymce.init({
    selector: 'textarea#content',
    plugins: 'image link media',
    toolbar: 'orcaimage',
    
    // Custom image picker button
    setup: function(editor) {
        editor.ui.registry.addButton('orcaimage', {
            text: 'ORCA Assets',
            icon: 'image',
            onAction: function() {
                openOrcaAssetPicker(function(asset) {
                    editor.insertContent(`<img src="${asset.url}" alt="${asset.alt_text || asset.filename}">`);
                });
            }
        });
    }
});

// ORCA Asset Picker Modal
function openOrcaAssetPicker(callback) {
    const modal = document.createElement('div');
    modal.className = 'orca-modal';
    modal.innerHTML = `
        <div class="orca-modal-content">
            <div class="orca-modal-header">
                <h3>Select Asset</h3>
                <button onclick="this.closest('.orca-modal').remove()">×</button>
            </div>
            <div class="orca-modal-body">
                <input type="text" id="orca-search" placeholder="Search..." />
                <div id="orca-assets-grid"></div>
                <div id="orca-pagination"></div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadOrcaAssets();
    
    function loadOrcaAssets(page = 1, search = '') {
        fetch(`https://your-orca-dam.com/api/assets/search?q=${search}&page=${page}&per_page=24`, {
            headers: {
                'Authorization': 'Bearer YOUR_API_TOKEN',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById('orca-assets-grid');
            grid.innerHTML = data.data.map(asset => `
                <div class="orca-asset" onclick='selectAsset(${JSON.stringify(asset)})'>
                    <img src="${asset.thumbnail_url || asset.url}" alt="${asset.filename}">
                    <p>${asset.filename}</p>
                </div>
            `).join('');
        });
    }
    
    window.selectAsset = function(asset) {
        callback(asset);
        modal.remove();
    };
}
```

### CSS for Modal

```css
.orca-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.orca-modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: hidden;
}

.orca-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.orca-modal-body {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(90vh - 80px);
}

#orca-assets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.orca-asset {
    cursor: pointer;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    transition: all 0.2s;
}

.orca-asset:hover {
    border-color: #3b82f6;
    transform: scale(1.05);
}

.orca-asset img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 4px;
}

.orca-asset p {
    margin-top: 8px;
    font-size: 12px;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
```

---

## CKEditor Integration

```javascript
ClassicEditor
    .create(document.querySelector('#editor'), {
        toolbar: {
            items: [
                'heading', '|',
                'bold', 'italic', 'link', '|',
                'orcaImageUpload', '|',
                'bulletedList', 'numberedList'
            ]
        }
    })
    .then(editor => {
        // Add custom ORCA button
        editor.ui.componentFactory.add('orcaImageUpload', locale => {
            const view = new ButtonView(locale);
            
            view.set({
                label: 'Insert from ORCA',
                icon: '<svg>...</svg>',
                tooltip: true
            });
            
            view.on('execute', () => {
                openOrcaAssetPicker(asset => {
                    editor.model.change(writer => {
                        const imageElement = writer.createElement('imageBlock', {
                            src: asset.url,
                            alt: asset.alt_text || asset.filename
                        });
                        
                        editor.model.insertContent(imageElement, editor.model.document.selection);
                    });
                });
            });
            
            return view;
        });
    });
```

---

## Quill Editor Integration

```javascript
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: {
            container: [
                ['bold', 'italic', 'underline'],
                ['image'],
                ['orca-assets']
            ],
            handlers: {
                'orca-assets': function() {
                    openOrcaAssetPicker(asset => {
                        const range = this.quill.getSelection();
                        this.quill.insertEmbed(range.index, 'image', asset.url);
                    });
                }
            }
        }
    }
});
```

---

## React Component Example

```jsx
import React, { useState, useEffect } from 'react';

function OrcaAssetPicker({ onSelect, apiToken }) {
    const [assets, setAssets] = useState([]);
    const [search, setSearch] = useState('');
    const [loading, setLoading] = useState(false);
    
    useEffect(() => {
        fetchAssets();
    }, [search]);
    
    const fetchAssets = async () => {
        setLoading(true);
        try {
            const response = await fetch(
                `https://your-orca-dam.com/api/assets/search?q=${search}&per_page=24`,
                {
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Accept': 'application/json'
                    }
                }
            );
            const data = await response.json();
            setAssets(data.data);
        } catch (error) {
            console.error('Failed to fetch assets:', error);
        } finally {
            setLoading(false);
        }
    };
    
    return (
        <div className="orca-picker">
            <input
                type="text"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Search assets..."
                className="search-input"
            />
            
            {loading ? (
                <div className="loading">Loading...</div>
            ) : (
                <div className="assets-grid">
                    {assets.map(asset => (
                        <div
                            key={asset.id}
                            onClick={() => onSelect(asset)}
                            className="asset-card"
                        >
                            <img
                                src={asset.thumbnail_url || asset.url}
                                alt={asset.filename}
                            />
                            <p>{asset.filename}</p>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// Usage in your editor
function MyEditor() {
    const [showPicker, setShowPicker] = useState(false);
    
    const handleAssetSelect = (asset) => {
        // Insert into editor (implementation depends on your editor)
        insertImage(asset.url, asset.alt_text);
        setShowPicker(false);
    };
    
    return (
        <>
            <button onClick={() => setShowPicker(true)}>
                Insert from ORCA
            </button>
            
            {showPicker && (
                <OrcaAssetPicker
                    onSelect={handleAssetSelect}
                    apiToken="your-api-token"
                />
            )}
        </>
    );
}
```

---

## Vue Component Example

```vue
<template>
  <div class="orca-asset-picker">
    <input
      v-model="searchQuery"
      @input="debouncedSearch"
      placeholder="Search assets..."
      class="search-input"
    />
    
    <div v-if="loading" class="loading">
      Loading...
    </div>
    
    <div v-else class="assets-grid">
      <div
        v-for="asset in assets"
        :key="asset.id"
        @click="selectAsset(asset)"
        class="asset-card"
      >
        <img
          :src="asset.thumbnail_url || asset.url"
          :alt="asset.filename"
        />
        <p>{{ asset.filename }}</p>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from 'vue';
import { debounce } from 'lodash';

export default {
  name: 'OrcaAssetPicker',
  props: {
    apiToken: String,
    onSelect: Function
  },
  setup(props) {
    const assets = ref([]);
    const searchQuery = ref('');
    const loading = ref(false);
    
    const fetchAssets = async () => {
      loading.value = true;
      try {
        const response = await fetch(
          `https://your-orca-dam.com/api/assets/search?q=${searchQuery.value}`,
          {
            headers: {
              'Authorization': `Bearer ${props.apiToken}`,
              'Accept': 'application/json'
            }
          }
        );
        const data = await response.json();
        assets.value = data.data;
      } catch (error) {
        console.error('Failed to fetch assets:', error);
      } finally {
        loading.value = false;
      }
    };
    
    const debouncedSearch = debounce(fetchAssets, 300);
    
    const selectAsset = (asset) => {
      props.onSelect(asset);
    };
    
    onMounted(() => {
      fetchAssets();
    });
    
    return {
      assets,
      searchQuery,
      loading,
      debouncedSearch,
      selectAsset
    };
  }
};
</script>
```

---

## WordPress Gutenberg Block

```javascript
import { registerBlockType } from '@wordpress/blocks';
import { Button, Modal } from '@wordpress/components';
import { useState } from '@wordpress/element';

registerBlockType('orca/image-block', {
    title: 'ORCA Image',
    icon: 'format-image',
    category: 'media',
    
    edit: function(props) {
        const [isOpen, setIsOpen] = useState(false);
        const { attributes, setAttributes } = props;
        
        const selectAsset = (asset) => {
            setAttributes({
                url: asset.url,
                alt: asset.alt_text || asset.filename,
                id: asset.id
            });
            setIsOpen(false);
        };
        
        return (
            <>
                {attributes.url ? (
                    <img src={attributes.url} alt={attributes.alt} />
                ) : (
                    <Button onClick={() => setIsOpen(true)}>
                        Select from ORCA
                    </Button>
                )}
                
                {isOpen && (
                    <Modal
                        title="Select Asset from ORCA"
                        onRequestClose={() => setIsOpen(false)}
                    >
                        <OrcaAssetPicker onSelect={selectAsset} />
                    </Modal>
                )}
            </>
        );
    },
    
    save: function(props) {
        return (
            <img
                src={props.attributes.url}
                alt={props.attributes.alt}
            />
        );
    }
});
```

---

## API Token Generation

To generate an API token for your RTE:

```php
// In your Laravel application
$user = User::find(1); // Your service user
$token = $user->createToken('rte-integration')->plainTextToken;
```

Store this token securely in your RTE configuration.

---

## CORS Configuration

If your RTE is on a different domain, configure CORS in Laravel:

```php
// config/cors.php
return [
    'paths' => ['api/*'],
    'allowed_methods' => ['*'],
    'allowed_origins' => ['https://your-website.com'],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => true,
];
```

---

## API Quick Reference

### Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/api/assets` | List assets with pagination, search, filters, sorting |
| `GET` | `/api/assets/search` | Search assets (optimized for picker) |
| `GET` | `/api/assets/{id}` | Get single asset details |
| `GET` | `/api/assets/meta?url=` | Get metadata by URL (public, no auth, accepts custom domain & S3 URLs) |
| `POST` | `/api/assets` | Upload files |
| `PATCH` | `/api/assets/{id}` | Update asset metadata |
| `GET` | `/api/tags` | List all tags |
| `GET` | `/api/folders` | List available S3 folders (for folder dropdowns) |
| `POST` | `/api/reference-tags` | Add reference tags to asset (by `asset_id` or `s3_key`) |
| `DELETE` | `/api/reference-tags/{tag}` | Remove reference tag from asset |

### Common Query Parameters
| Parameter | Description | Example |
|-----------|-------------|---------|
| `search` / `q` | Filter by filename | `?search=logo` |
| `type` | Filter by file type | `?type=image` |
| `tags` | Filter by tag IDs | `?tags=1,2,3` |
| `per_page` | Results per page (max 100) | `?per_page=24` |
| `page` | Page number | `?page=2` |
| `folder` | Filter by S3 folder | `?folder=assets/marketing` |
| `sort` | Sort order | `?sort=upload_desc` |

### Sort Options
| Value | Description |
|-------|-------------|
| `date_desc` | Newest modified first (default) |
| `date_asc` | Oldest modified first |
| `upload_desc` | Newest uploads first |
| `upload_asc` | Oldest uploads first |
| `size_desc` | Largest first |
| `size_asc` | Smallest first |
| `name_asc` | Name A-Z |
| `name_desc` | Name Z-A |

---

## Best Practices

1. **Token Security**:
   - **Sanctum tokens**: Never expose in client-side code. Use server-side proxy.
   - **JWT secrets**: Store securely in your backend. Never commit to version control.
   - **JWTs**: Safe to pass to frontend since they're short-lived and tied to a specific user.

2. **JWT Token Lifecycle**:
   - Generate JWTs with short expiry (1 hour recommended)
   - Refresh tokens when they expire (re-request from your backend)
   - Your backend should validate user session before generating JWTs

3. **Error Handling**: Always handle API errors gracefully in your RTE integration.

4. **Caching**: Consider caching asset lists to reduce API calls.

5. **Pagination**: Implement infinite scroll or load-more for better UX with large asset libraries.

6. **Search Debouncing**: Debounce search inputs to avoid excessive API calls.

7. **Thumbnails**: Use thumbnail URLs for grid views, full URLs only when inserting.

8. **Alt Text**: Always use the asset's alt_text when available for accessibility.

9. **Custom Domain**: If your ORCA admin has configured a custom domain (CDN), asset URLs will use
   that domain automatically. The `/api/assets/meta` endpoint accepts both custom domain and S3 URLs.

10. **CORS**: If your RTE is on a different domain, configure CORS in Laravel (see below).
